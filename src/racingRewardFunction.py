import math
def reward_function(params):

    # Read input parameters
    track_width = params['track_width']
    distance_from_center = params['distance_from_center']
    all_wheels_on_track = params['all_wheels_on_track']
    speed = params["speed"]
    waypoints = params['waypoints']
    closest_waypoints = params['closest_waypoints']
    heading = params['heading']
    progress = params['progress']
    is_crashed = params['is_crashed']
    is_offtrack = params['is_offtrack']
    is_reversed = params['is_reversed']
    steps = params['steps']
    x = params['x']
    y = params['y']
    is_left_of_center = params['is_left_of_center']
    
    reward=0
    
    # Control panel
    POSITION_REWARD_RATE = 0.3
    RIGHT_SIDE_REWARD_RATE = 0.3
    CENTER_DIST_REWARD_RATE = 0.3
    SPEED_REWARD_RATE = 0.8
    ADDITIONAL_SPEED_RATE = 0
    DIRECTION_REWARD_RATE = 0.3
    PROGRESS_REWARD_RATE = 0.5
    STEP_REWARD_RATE = 2.0
    
    HUNDRED_TEN_BASE = 1.584893192461113
    HUNDRED_TEN_POWER = 10
    HUNDRED_EIGHT_BASE = 1.778279410038923
    HUNDRED_EIGHT_POWER = 8
    HUNDRED_SIX_BASE = 2.1544346900318843
    HUNDRED_SIX_POWER = 6
    HUNDRED_FOUR_BASE = 3.162277660168379
    HUNDRED_FOUR_POWER = 4
    HUNDRED_TWO_BASE = 10
    HUNDRED_TWO_POWER = 2

##### START: Ideal Route Data Map #####
    dataMap = [
        [0.8447664169715376, 5.588622225423285 , -132.23263471307527 , 3.9922888429466385 , 4.577566798522238e-15 , 1 , 89 , 2.0],
        [0.8394100010158559, 5.5824394921140135 , -132.02559287039506 , 2.8469310650262547 , 0.00018966984446087525 , 1 , 89 , 3.0],
        [0.8173370474277692, 5.569165622534925 , -133.8186720802598 , 4.0 , 0.006965535742008526 , 0 , 90 , 4.0],
        [0.7854661112452175, 5.549674842097248 , -136.0871961074302 , 4.0 , 0.016471032505654463 , 0 , 90 , 5.0],
        [0.7536613262785073, 5.5194749134462375 , -136.2583913948305 , 3.9017704822585575 , 0.018514974777920183 , 0 , 90 , 6.0],
        [0.7064382604220698, 5.46776827346438 , -135.24641319120758 , 4.0 , 0.016796226879480458 , 0 , 90 , 7.0],
        [0.6647515200583665, 5.407682648369601 , -132.28262473015707 , 4.0 , 0.00528167661466409 , 0 , 90 , 8.0],
        [0.6154077951027841, 5.32281338420733 , -127.80025513882288 , 2.8055376884739527 , 0.01815194737558146 , 1 , 91 , 9.0],
        [0.560403338326781, 5.233411673805965 , -125.23046766396659 , 2.0 , 0.04153695487830243 , 1 , 91 , 10.0],
        [0.4860247059548912, 5.146091966374238 , -127.34524743182803 , 2.0 , 0.04963864817099356 , 1 , 91 , 11.0],
        [0.41150647125100426, 5.077231490681164 , -131.11534193524963 , 2.0 , 0.045032562491208836 , 1 , 92 , 12.0],
        [0.29508592078766394, 4.993952454941584 , -137.67862452952454 , 3.226974063708175 , 0.021441623474860026 , 1 , 92 , 13.0],
        [0.1840674922603068, 4.935044720461775 , -144.41219774068645 , 4.0 , 0.015539230238902866 , 0 , 92 , 14.0],
        [0.045927168315566175, 4.8618940114361715 , -149.00163570464397 , 3.1344728066856744 , 0.058412218015965744 , 0 , 93 , 15.0],
        [-0.08193734151904133, 4.774566027316514 , -147.2105786970463 , 2.9486395750699366 , 0.08385219478218159 , 0 , 94 , 16.0],
        [-0.24464760931624724, 4.6426748594034795 , -143.08666122654094 , 2.982621221090248 , 0.09261776169116069 , 0 , 94 , 17.0],
        [-0.3706592522317379, 4.533689221007727 , -140.8532842437774 , 4.0 , 0.08952041421184563 , 0 , 95 , 18.0],
        [-0.4914185467387829, 4.4326480103770765 , -140.53752434871586 , 4.0 , 0.08425996652941377 , 0 , 95 , 19.0],
        [-0.6595571996871719, 4.305816850904529 , -142.26501393239408 , 3.3003903119510576 , 0.0781060279080302 , 0 , 96 , 20.0],
        [-0.8458714610992862, 4.186293465809675 , -145.94855540070148 , 3.558979537457437 , 0.0798969681967137 , 0 , 97 , 21.0],
        [-1.0627892619318504, 4.07345443325599 , -151.31832058724032 , 3.493018398412994 , 0.09319362637092925 , 0 , 98 , 22.0],
        [-1.2305775683236193, 4.001531311171468 , -155.71297083658087 , 3.6979295523803057 , 0.1076024407741151 , 0 , 98 , 23.0],
        [-1.4556701784904482, 3.907564863502712 , -158.86509078550236 , 3.874661183515 , 0.12093151751509022 , 0 , 99 , 24.0],
        [-1.6865301870297038, 3.8196932427200556 , -161.02176044878254 , 3.940043104068665 , 0.13153842768051302 , 0 , 100 , 25.0],
        [-1.8890082487206292, 3.753486696123897 , -162.70309647064047 , 3.836400747360316 , 0.14292009866684927 , 0 , 101 , 26.0],
        [-2.1489550602270064, 3.681510055228907 , -164.3001280135885 , 4.0 , 0.15627720059690323 , 0 , 101 , 27.0],
        [-2.3654478655601823, 3.6274910891746464 , -165.45898123057492 , 3.8051993225811347 , 0.16041718073228253 , 0 , 102 , 28.0],
        [-2.595460920316901, 3.5762638203972394 , -166.94336028429777 , 4.0 , 0.16200780745942203 , 0 , 103 , 29.0],
        [-2.854010850016793, 3.521644365281761 , -167.78943363769955 , 4.0 , 0.15586618936268623 , 0 , 104 , 30.0],
        [-3.067592338106626, 3.4824705768159188 , -169.05865984946828 , 3.8589596093265834 , 0.14878821484698376 , 0 , 105 , 31.0],
        [-3.291171089419584, 3.453214995740391 , -171.54722059486187 , 4.0 , 0.14485559299718875 , 0 , 105 , 32.0],
        [-3.5622099317495453, 3.433744743371262 , -175.19374543790866 , 3.8681795237414454 , 0.14381090541529656 , 0 , 106 , 33.0],
        [-3.7768603007334844, 3.4206596474868958 , -176.2123679069603 , 3.7275109924951266 , 0.13417097498977518 , 0 , 107 , 34.0],
        [-4.021370862349743, 3.3923689901342096 , -174.17750511437404 , 3.9477670672100436 , 0.09684337899102677 , 0 , 108 , 35.0],
        [-4.260079518708651, 3.354059880427703 , -171.72705328096418 , 3.714625077942813 , 0.03716484421296365 , 0 , 109 , 36.0],
        [-4.524673959130332, 3.2953252295065383 , -168.31408455881032 , 2.87590787709434 , 0.05311622572267326 , 1 , 110 , 37.0],
        [-4.769448558092431, 3.244865889870985 , -168.3350686385969 , 2.950337696648779 , 0.11408605051180197 , 1 , 110 , 38.0],
        [-4.94514058288143, 3.2099188280005695 , -168.58750662558208 , 2.782250983227912 , 0.13846685938551648 , 1 , 111 , 39.0],
        [-5.1682096621340765, 3.1626923948695507 , -168.1494331273188 , 2.4950905784590507 , 0.16162885227874016 , 1 , 112 , 40.0],
        [-5.370103827661955, 3.111768770002226 , -166.62850748064744 , 2.6007445887897465 , 0.18192578944725946 , 1 , 113 , 41.0],
        [-5.553236947843074, 3.057971926135078 , -164.79209039389806 , 2.8950093153447085 , 0.19352726387897298 , 1 , 113 , 42.0],
        [-5.728932248283666, 2.9889909999208797 , -160.7102801586411 , 2.666142803820225 , 0.21293050124231463 , 1 , 114 , 43.0],
        [-5.919347358962665, 2.900189632481241 , -156.87997933515427 , 3.3680706604502397 , 0.23533552896097756 , 1 , 115 , 44.0],
        [-6.093277018706835, 2.8037348235587864 , -152.9990377555098 , 3.434163872003937 , 0.2516925848431957 , 1 , 115 , 45.0],
        [-6.2614595577510075, 2.6864536198859934 , -147.43283576732372 , 3.5748026554002816 , 0.2728899289777499 , 1 , 116 , 46.0],
        [-6.421372834443856, 2.5513521040545797 , -140.79452088250036 , 3.7519017336406257 , 0.29751595482759946 , 1 , 117 , 47.0],
        [-6.57104466915508, 2.3968547883090237 , -132.43226394224138 , 3.1571767132832886 , 0.32571535392196543 , 1 , 118 , 48.0],
        [-6.708385029334507, 2.2346205996292574 , -124.76687638238012 , 3.835049496549336 , 0.34654573384927595 , 1 , 118 , 49.0],
        [-6.847402379595717, 2.0476132459478795 , -117.11757250546819 , 3.7051913319389262 , 0.358803385429898 , 1 , 119 , 50.0],
        [-6.967544841345355, 1.8589073765573974 , -110.11983127748064 , 3.044053107177674 , 0.3658872342079681 , 1 , 120 , 51.0],
        [-7.07483415504867, 1.6674684036086918 , -103.29763121611674 , 3.2354659348169945 , 0.3698121863591194 , 1 , 121 , 52.0],
        [-7.17659982966054, 1.4652077220427324 , -97.90211354432049 , 3.1918440283836906 , 0.37304428924795235 , 1 , 122 , 53.0],
        [-7.269572797852499, 1.2466173155123434 , -93.21317586149763 , 3.8169284504035037 , 0.38341028604213856 , 1 , 123 , 54.0],
        [-7.34177829285676, 1.038437332943258 , -89.51599843946477 , 2.7469509129509597 , 0.3980131478053031 , 1 , 123 , 55.0],
        [-7.396136092137296, 0.8410387364368577 , -86.41086950421708 , 3.0750076099566033 , 0.4132666861920569 , 1 , 124 , 56.0],
        [-7.4500697771381335, 0.5794047739965892 , -83.36026149638019 , 3.1799884725339167 , 0.43711112672619445 , 1 , 125 , 57.0],
        [-7.471763437808644, 0.4254089824771433 , -82.40127855578667 , 2.901389557197979 , 0.45445654957463893 , 1 , 126 , 58.0],
        [-7.49910814228298, 0.22727022096060154 , -82.723643569663 , 3.266290293298684 , 0.4688318899020852 , 1 , 126 , 59.0],
        [-7.527252845749535, 0.02627831260453367 , -85.26722732314431 , 2.796412730377095 , 0.47599152221982766 , 1 , 127 , 60.0],
        [-7.558730689117794, -0.18176714011424117 , -90.16366621750535 , 2.998221582331969 , 0.4760989021744331 , 1 , 128 , 61.0],
        [-7.5903038836866505, -0.386139956267542 , -96.21373118951712 , 3.0912359913285945 , 0.47066478409452656 , 1 , 129 , 62.0],
        [-7.623921470655205, -0.597398230284566 , -99.29240042769004 , 4.0 , 0.45515824642782793 , 1 , 129 , 63.0],
        [-7.65717709642968, -0.7930476162640084 , -99.57309042974717 , 3.4359707653462035 , 0.4321315045778023 , 1 , 130 , 64.0],
        [-7.675903133525504, -1.046596750505217 , -95.07722232820701 , 3.16838878182464 , 0.41820393246773724 , 1 , 131 , 65.0],
        [-7.677223165606523, -1.2496723508208867 , -91.50141470493459 , 3.8462068724860954 , 0.41447404611154 , 1 , 132 , 66.0],
        [-7.6677067363607305, -1.4556179314762812 , -88.52872133019603 , 3.950117455772678 , 0.4154790764388525 , 1 , 132 , 67.0],
        [-7.631569757231905, -1.7484999612232028 , -83.42529342346972 , 4.0 , 0.4288436003632955 , 1 , 133 , 68.0],
        [-7.595962463370562, -1.9392538192957192 , -80.56652105204917 , 3.6744920417533886 , 0.43960535522708244 , 1 , 134 , 69.0],
        [-7.553555732220668, -2.1675604860228264 , -79.69314038260683 , 4.0 , 0.4435190482848002 , 1 , 135 , 70.0],
        [-7.521363681369034, -2.3968152976773323 , -81.39577492084844 , 4.0 , 0.42644120952174086 , 1 , 136 , 71.0],
        [-7.4843614478574825, -2.658485343232972 , -81.89648885798785 , 2.3003606991821894 , 0.39392709972383966 , 1 , 137 , 72.0],
        [-7.443317289546809, -2.860570109972052 , -79.60117697876247 , 2.52445411479893 , 0.372930795340797 , 1 , 137 , 73.0],
        [-7.391127133955829, -3.0627579192966685 , -76.82909439956173 , 3.5457890356786317 , 0.3518801400667096 , 1 , 138 , 74.0],
        [-7.328605977361325, -3.2661160488650762 , -74.12578630469115 , 3.364773200885037 , 0.3305742774073955 , 1 , 139 , 75.0],
        [-7.243580380570059, -3.477588255884614 , -69.6507944825022 , 3.4432869612205814 , 0.31512076745372014 , 1 , 140 , 76.0],
        [-7.120875426850101, -3.7194065540821444 , -63.438977988156374 , 3.457107150396098 , 0.303741597208453 , 1 , 141 , 77.0],
        [-7.021965973656821, -3.8843595533551873 , -59.1134222861392 , 3.572719208573735 , 0.3006528403920413 , 1 , 141 , 78.0],
        [-6.884626294785706, -4.085944194981523 , -53.854608105885696 , 3.7438241817762767 , 0.2955905109854559 , 1 , 142 , 79.0],
        [-6.740797370291548, -4.267456846210332 , -48.30372695748627 , 3.475786721088687 , 0.2907765004368065 , 1 , 143 , 80.0],
        [-6.57501059522686, -4.453182595373295 , -42.67806731507621 , 3.4587056770982714 , 0.2812416075574386 , 1 , 144 , 81.0],
        [-6.4159344816061505, -4.611969601788855 , -38.08247426740708 , 3.377883405171847 , 0.26823271239709917 , 1 , 145 , 82.0],
        [-6.242475453801075, -4.766184767247031 , -33.53793879018099 , 3.5750012591626565 , 0.2508001497187444 , 1 , 146 , 83.0],
        [-6.058323784328256, -4.913244389441694 , -29.70367228140105 , 4.0 , 0.22684767535056394 , 1 , 146 , 84.0],
        [-5.855606078609089, -5.05733501962054 , -26.890215184573485 , 3.618822921070768 , 0.19662362461603725 , 1 , 147 , 85.0],
        [-5.654586832214137, -5.179442766473168 , -23.72218291454303 , 3.715989136401218 , 0.16939019820356044 , 1 , 148 , 86.0],
        [-5.427009238857147, -5.296788305076281 , -20.054131325616105 , 3.4362422393161998 , 0.1363458389109414 , 1 , 149 , 87.0],
        [-5.214287362158237, -5.388575783104018 , -16.076000555277574 , 3.816310669376704 , 0.10252069760271562 , 1 , 150 , 88.0],
        [-4.978641766566022, -5.474830339146825 , -11.923990632994347 , 3.7616200138949005 , 0.06265748528639094 , 1 , 151 , 89.0],
        [-4.722011337795127, -5.549281536014905 , -7.523480393529252 , 3.93203249285321 , 0.02766965309993829 , 1 , 152 , 90.0],
        [-4.485614974205927, -5.603823631051943 , -3.762085982843146 , 4.0 , 0.005244003956820975 , 1 , 152 , 91.0],
        [-4.253539949435823, -5.645122176296145 , -0.6280300266539726 , 3.5338996278618193 , 0.00558812974661428 , 0 , 153 , 92.0],
        [-4.0158866257112, -5.678825689578248 , 1.9742234211927252 , 2.5920727327428144 , 0.008500894519853917 , 0 , 154 , 93.0],
        [-3.796438828167224, -5.7123002130287395 , 3.603844013698485 , 2.0 , 0.013483451689617164 , 0 , 155 , 94.0],
        [-3.5893766847921738, -5.755357484312689 , 1.6807076551193243 , 2.0845038462736163 , 0.029167568583909516 , 0 , 155 , 95.0],
        [-3.389437192763643, -5.810496272187863 , -4.52991507367314 , 4.0 , 0.05756942571760526 , 0 , 156 , 96.0],
        [-3.1907482108563396, -5.868824870136315 , -12.789440093179635 , 3.1790661740358503 , 0.0891045985424636 , 0 , 157 , 97.0],
        [-3.008173100134296, -5.914202046110397 , -15.733139556438509 , 2.853422216549597 , 0.10961995470675163 , 0 , 157 , 98.0],
        [-2.815286979444152, -5.9588384121369415 , -16.068711829652916 , 3.0759179121997438 , 0.12746386360631554 , 0 , 158 , 99.0],
        [-2.6082960773041153, -6.020371155090765 , -16.748670371438315 , 3.0211099222661835 , 0.1596093300059176 , 0 , 159 , 100.0],
        [-2.404516289466438, -6.082500164927146 , -16.971374891769315 , 3.2351678732697398 , 0.19198266273517703 , 0 , 159 , 101.0],
        [-2.223464374869095, -6.1329947251805494 , -16.071385354162878 , 3.1324166743888853 , 0.21525954035061434 , 0 , 160 , 102.0],
        [-2.0175018902586954, -6.195074279708918 , -16.72807921732561 , 3.1524423600091396 , 0.24582817878946303 , 0 , 1 , 103.0],
        [-1.8272715884497668, -6.25593686450867 , -17.27166665515945 , 3.72049812202835 , 0.27696216005363383 , 0 , 1 , 104.0],
        [-1.586088161254105, -6.313346874029674 , -14.056541593661425 , 4.0 , 0.2961536035262713 , 0 , 2 , 105.0],
        [-1.3616382650584313, -6.346783153231373 , -9.084507031631588 , 3.0977036678118273 , 0.2935442672066882 , 0 , 3 , 106.0],
        [-1.1428225012532585, -6.365597870887727 , -4.731133229561941 , 2.7416310866933378 , 0.2767659482486228 , 0 , 4 , 107.0],
        [-0.9460059990880227, -6.374429584199938 , -1.5105198277797096 , 2.5803907929792165 , 0.2529942509184623 , 0 , 4 , 108.0],
        [-0.7248243623627728, -6.383464861804323 , -0.43103061601163745 , 3.879888688981909 , 0.22521743511103065 , 0 , 5 , 109.0],
        [-0.5361677069140848, -6.395884299129422 , -2.1323693383807885 , 4.0 , 0.20604616201004344 , 0 , 6 , 110.0],
        [-0.33172832870527036, -6.415823976178456 , -4.61198024932046 , 3.8472420033076595 , 0.19142876823691515 , 0 , 6 , 111.0],
        [-0.06683233135939515, -6.451101162328347 , -6.965606023183703 , 3.7040441926327694 , 0.18049644091086783 , 0 , 7 , 112.0],
        [0.10267763488298054, -6.474468030186172 , -7.50280675878935 , 3.404772441593892 , 0.17255070890715685 , 0 , 8 , 113.0],
        [0.369353746300774, -6.502833270668411 , -6.332759256232973 , 3.7820099609629096 , 0.14810176398883562 , 0 , 9 , 114.0],
        [0.5822379955825352, -6.522209406297898 , -5.57653141836956 , 3.9514069758889145 , 0.12132689781735707 , 0 , 9 , 115.0],
        [0.8003620979888966, -6.538173779410796 , -4.65298574798126 , 2.940178803525978 , 0.08633412128600731 , 0 , 10 , 116.0],
        [1.0568863147908978, -6.545112907830102 , -2.2501574171187775 , 3.5589529847727346 , 0.030731643805548766 , 0 , 11 , 117.0],
        [1.2802481258306333, -6.538949597966332 , 0.39954862043158496 , 3.0104663490673946 , 0.029480621296002308 , 1 , 12 , 118.0],
        [1.4920351376726986, -6.52708096181865 , 2.2851691519395416 , 2.8794055444716724 , 0.08622654148488844 , 1 , 12 , 119.0],
        [1.7136453406337409, -6.502289253094144 , 5.212911037672083 , 3.0703327585031612 , 0.13054760323321213 , 1 , 13 , 120.0],
        [1.9387602868028875, -6.461206084264303 , 9.530097829165639 , 2.8565184109304456 , 0.169886732873334 , 1 , 14 , 121.0],
        [2.1356670724175886, -6.411784934673815 , 13.83439951460232 , 3.1652965443205137 , 0.20173634093527612 , 1 , 15 , 122.0],
        [2.3326721110666875, -6.351809225076315 , 17.542139605094537 , 3.2663774090936006 , 0.22474452890707594 , 1 , 15 , 123.0],
        [2.560424913658429, -6.263024946136004 , 21.77791944095328 , 3.258270604848314 , 0.24437327804139686 , 1 , 16 , 124.0],
        [2.7528037039259465, -6.172993729431838 , 25.429278087829253 , 3.3503701819624623 , 0.25192761009584674 , 1 , 17 , 125.0],
        [2.950445489708948, -6.066306968200869 , 28.852575814528773 , 3.4952379059406398 , 0.2497447435015554 , 1 , 18 , 126.0],
        [3.137587204082587, -5.947920495697066 , 32.682438121644786 , 3.4757568321182397 , 0.24047835035619153 , 1 , 19 , 127.0],
        [3.328802248322172, -5.803126569884883 , 38.5729494139596 , 3.717552614438411 , 0.22889606305882235 , 1 , 20 , 128.0],
        [3.514301343719639, -5.639380315225899 , 45.59255209116953 , 3.788494341630583 , 0.2216390501929363 , 1 , 20 , 129.0],
        [3.6850691346675437, -5.468081614610719 , 51.704548310346624 , 3.529691426033543 , 0.2207746774031565 , 1 , 21 , 130.0],
        [3.842958948169335, -5.298682452472649 , 56.10814647255264 , 3.4177818698467783 , 0.2173067939181592 , 1 , 22 , 131.0],
        [4.011586252759675, -5.101026074268172 , 59.86851647042992 , 3.2138227965027197 , 0.21235831281069376 , 1 , 23 , 132.0],
        [4.14194028845736, -4.928391498517184 , 63.4044544562963 , 2.9902563746395896 , 0.21390245000870164 , 1 , 24 , 133.0],
        [4.2678898807056544, -4.740611934832432 , 67.44426642887383 , 3.739008178354751 , 0.22590749583165334 , 1 , 24 , 134.0],
        [4.3995672055505395, -4.517042866381528 , 71.85920829756901 , 3.8606902282294353 , 0.2489177164999693 , 1 , 25 , 135.0],
        [4.490427751313534, -4.334859072392953 , 74.7790505588125 , 2.980231942147949 , 0.2696143243016086 , 1 , 26 , 136.0],
        [4.579377272625586, -4.126871108601643 , 78.352729540646 , 2.5698406854283014 , 0.2857349846060845 , 1 , 27 , 137.0],
        [4.6516690363532565, -3.933788353213668 , 81.6388725983818 , 3.386818893068183 , 0.28300225590934813 , 1 , 28 , 138.0],
        [4.705823098422869, -3.751359401973005 , 84.63855002446661 , 3.0245528914264836 , 0.2676415704716083 , 1 , 28 , 139.0],
        [4.747646179356453, -3.5524524857786735 , 89.18530920598819 , 3.636275324689706 , 0.23842711554205165 , 1 , 29 , 140.0],
        [4.776483358585535, -3.3404262112653442 , 93.17194342699104 , 3.644105068158318 , 0.2032490706929272 , 1 , 30 , 141.0],
        [4.789114112675478, -3.099636923729562 , 98.05456410391893 , 3.4770596540509073 , 0.1644405649566411 , 1 , 31 , 142.0],
        [4.786349620356854, -2.9126631637183285 , 101.58639405429571 , 3.741489600583896 , 0.13743606542801345 , 1 , 31 , 143.0],
        [4.777351115897507, -2.6801399136589503 , 103.61590869457922 , 2.995474259781059 , 0.10172148082773533 , 1 , 32 , 144.0],
        [4.772963601332184, -2.456435755737063 , 101.97513101448193 , 3.786693250301898 , 0.05207789785566742 , 1 , 33 , 145.0],
        [4.777391422843933, -2.2192820301762213 , 96.31567955235934 , 3.862820082159702 , 0.015348772635465115 , 0 , 34 , 146.0],
        [4.7913488646046645, -1.9977320971840309 , 88.85119378571898 , 2.7042471709727325 , 0.0844373714671275 , 0 , 34 , 147.0],
        [4.816056371998644, -1.7578317465322968 , 82.30679364738825 , 3.0637317627027607 , 0.16091183605911794 , 0 , 35 , 148.0],
        [4.855721959681813, -1.5135659245964324 , 75.86451550385954 , 3.3738350981059693 , 0.24963444897622517 , 0 , 36 , 149.0],
        [4.8960142231535775, -1.3351235930149057 , 70.7630869779934 , 2.4085586462122412 , 0.32400940105929343 , 0 , 37 , 150.0],
        [4.950509211549854, -1.1467802012902966 , 65.35223353555168 , 3.000527863733711 , 0.40388421386845963 , 0 , 37 , 151.0],
        [5.017897930145523, -0.9535963527903676 , 60.4601377087821 , 3.1663151215787133 , 0.4783432037849123 , 0 , 38 , 152.0],
        [5.099171023980395, -0.762476525122223 , 55.930233522688404 , 3.269942258900397 , 0.5365906083243526 , 0 , 39 , 153.0],
        [5.188477036310787, -0.5898881478924556 , 51.56267929788758 , 3.2716653113644183 , 0.5752268615838839 , 0 , 40 , 154.0],
        [5.30679203750411, -0.3949282771225766 , 47.29820384015441 , 3.075520704129623 , 0.6019764316752713 , 0 , 41 , 155.0],
        [5.4379983557684035, -0.20831736020463254 , 42.902177175726266 , 3.0166631520624496 , 0.6110090006283488 , 0 , 42 , 156.0],
        [5.54897035834532, -0.0682523578993794 , 40.073273933919545 , 3.486624052913009 , 0.60740665901567 , 0 , 43 , 157.0],
        [5.693552239039027, 0.0950562791678215 , 37.41375102993422 , 3.4829235047517813 , 0.586823060208995 , 0 , 45 , 158.0],
        [5.875012573349805, 0.273007498219816 , 34.618869561268326 , 3.5049126556640093 , 0.5434291977066307 , 0 , 46 , 159.0],
        [6.071522699252017, 0.44180026216747287 , 32.41775248638532 , 3.368556170431889 , 0.4928714166364689 , 0 , 47 , 160.0],
        [6.2032071803558075, 0.5413402749747749 , 30.748725604880526 , 3.1732006372970583 , 0.4653106874877702 , 0 , 47 , 161.0],
        [6.400939107665587, 0.6914312179666335 , 30.61134303087766 , 3.284398990301903 , 0.411481516530302 , 0 , 48 , 162.0],
        [6.563047694893226, 0.8237984055148271 , 34.31854254111982 , 2.6811976234187527 , 0.34538690958215673 , 0 , 49 , 163.0],
        [6.735573674188881, 0.9767357714304931 , 40.07863185351793 , 3.5863582458221703 , 0.2542949513168612 , 0 , 50 , 164.0],
        [6.890250666627222, 1.130764168848037 , 44.851984885716256 , 3.5585575427660134 , 0.1499431295023622 , 0 , 50 , 165.0],
        [7.028960419499901, 1.2962774643598796 , 51.84686984475318 , 3.23856436079401 , 0.04821284820832343 , 0 , 51 , 166.0],
        [7.150350672109764, 1.4645550450490863 , 59.16954457435786 , 3.5058154431921995 , 0.05227419728280687 , 1 , 52 , 167.0],
        [7.299319285403607, 1.6766441772037755 , 64.06145479777744 , 3.3040805997797453 , 0.134595808186903 , 1 , 52 , 168.0],
        [7.405790812580948, 1.8432785305945998 , 66.31990213636999 , 3.0469925017656796 , 0.17636815501258005 , 1 , 53 , 169.0],
        [7.515535800467012, 2.035398622569405 , 68.2243315347581 , 2.935056512743414 , 0.21264438128000845 , 1 , 54 , 170.0],
        [7.62294594874226, 2.2539638206731665 , 71.09117766944036 , 2.7291377562389405 , 0.2381744754422496 , 1 , 55 , 171.0],
        [7.729802914256309, 2.5036100348585197 , 73.63434765165195 , 2.657170387286001 , 0.24410805237747507 , 1 , 56 , 172.0],
        [7.77315824503651, 2.618404330572546 , 74.45598336956353 , 2.756486729205233 , 0.24103314767262374 , 1 , 56 , 173.0],
        [7.842780195177801, 2.8373175407980953 , 76.19159238972122 , 2.272258072372524 , 0.221552886132678 , 1 , 57 , 174.0],
        [7.892176702943697, 3.023284915071007 , 76.66489987814761 , 2.0 , 0.19377593643215 , 1 , 58 , 175.0],
        [7.923197346485301, 3.171426797053193 , 77.52078445374826 , 2.0 , 0.1695071975703694 , 1 , 58 , 176.0],
        [7.946809266521297, 3.333107080179358 , 80.01228966969614 , 2.0 , 0.13481115448406322 , 1 , 59 , 177.0],
        [7.958853874197644, 3.4848870772571554 , 82.93776486938853 , 2.0 , 0.1089102771189629 , 1 , 59 , 178.0],
        [7.961182503304064, 3.6294511169594896 , 86.0456481312481 , 2.0 , 0.07581578762179396 , 1 , 60 , 179.0],
        [7.953557927871332, 3.7729800311127653 , 89.56299553379309 , 2.0 , 0.0525076943160341 , 1 , 60 , 180.0],
        [7.931866310270454, 3.927133965716698 , 94.00373681941579 , 2.0 , 0.025212301821049037 , 1 , 61 , 181.0],
        [7.900837327889185, 4.060880646756157 , 98.43426170303745 , 2.0 , 0.012036989981387344 , 1 , 61 , 182.0],
        [7.861469094475524, 4.185720002409781 , 102.73183958431984 , 2.0 , 0.0005811203286304166 , 1 , 62 , 183.0],
        [7.798745925513602, 4.33191061991512 , 108.38230202432368 , 2.0 , 0.000460646665271994 , 1 , 62 , 184.0],
        [7.732061154669381, 4.456038486145109 , 113.3224988016486 , 2.0 , 0.002129794432113273 , 1 , 63 , 185.0],
        [7.6546662307096724, 4.57208563114561 , 118.38614072749404 , 2.8675139942414054 , 0.013843250659322721 , 1 , 63 , 186.0],
        [7.544893546570877, 4.704636745718735 , 125.14834672139044 , 3.8180243747416185 , 0.03293624246490666 , 1 , 64 , 187.0],
        [7.453576118978466, 4.791930311767819 , 130.7273697270167 , 3.831431415232453 , 0.057031556000218725 , 1 , 64 , 188.0],
        [7.327756463208182, 4.894463797999416 , 137.8673669787495 , 3.8286453591970577 , 0.09121555040013024 , 1 , 65 , 189.0],
        [7.16358356965404, 5.008354428608531 , 146.0782565904619 , 3.281465360197715 , 0.14188382968945285 , 1 , 65 , 190.0],
        [7.0070862570690275, 5.115166402762676 , 150.79393599185457 , 2.9277224290166637 , 0.18170427198548825 , 1 , 66 , 191.0],
        [6.860532981557734, 5.217283210401519 , 152.17490327092347 , 2.7484535340663814 , 0.21631121189831926 , 1 , 67 , 192.0],
        [6.6736471623676765, 5.336032656186069 , 153.59423649253668 , 3.1060409346698874 , 0.2657360248597979 , 1 , 67 , 193.0],
        [6.527786841435674, 5.431211444210194 , 151.12392511587404 , 3.3776029647342876 , 0.2952023414519479 , 1 , 68 , 194.0],
        [6.343184939138356, 5.548517014086814 , 148.32970456147999 , 4.0 , 0.3274927781831168 , 1 , 69 , 195.0],
        [6.1855595830958565, 5.652758031154507 , 147.2986538201725 , 3.418888647251449 , 0.3438093225496347 , 1 , 70 , 196.0],
        [5.982173474260002, 5.770487782830482 , 149.2033448916557 , 2.8045311742927237 , 0.3582458052443655 , 1 , 70 , 197.0],
        [5.771135850815283, 5.872278452276259 , 153.43712160078886 , 2.9233603302356324 , 0.37253367459373044 , 1 , 71 , 198.0],
        [5.6187638122614665, 5.938191428288217 , 155.5268428310865 , 3.2923807965250966 , 0.3786280625393257 , 1 , 72 , 199.0],
        [5.405370828216737, 6.015825488698601 , 158.8091987057959 , 2.973798968547821 , 0.38656276793310346 , 1 , 73 , 200.0],
        [5.206185283172604, 6.073164216389954 , 162.5475325549336 , 3.1635995128379184 , 0.3933728533599541 , 1 , 73 , 201.0],
        [4.987965969451738, 6.122251077525772 , 166.64347605678896 , 4.0 , 0.3948329783931626 , 1 , 74 , 202.0],
        [4.7907554634498695, 6.156662737566253 , 169.17204127912157 , 4.0 , 0.39677271974403105 , 1 , 75 , 203.0],
        [4.552162170642938, 6.200516508546905 , 169.38241739814703 , 4.0 , 0.38932979261097234 , 1 , 76 , 204.0],
        [4.334773289704311, 6.24374637608557 , 168.92333618699635 , 2.674129838651446 , 0.37265539722526847 , 1 , 77 , 205.0],
        [4.060184467613685, 6.289467646252784 , 170.47339774713586 , 3.8455834970649487 , 0.3456368762504571 , 1 , 78 , 206.0],
        [3.902000558308666, 6.306887861732766 , 172.47270903233164 , 3.617186043726555 , 0.33116091806269093 , 1 , 78 , 207.0],
        [3.656348797324373, 6.315413279252569 , 176.82542881656056 , 3.282259391022855 , 0.3196426289348726 , 1 , 79 , 208.0],
        [3.4689508563438767, 6.310917380481627 , -179.8921663765306 , 3.309805421491222 , 0.31705451159485204 , 1 , 80 , 209.0],
        [3.2001517159482042, 6.291650562117948 , -176.17868278109748 , 3.0587291433670387 , 0.320709611686344 , 1 , 81 , 210.0],
        [2.9854712073951406, 6.263998346401543 , -173.11596362216932 , 3.4121242316146105 , 0.3344765985204299 , 1 , 81 , 211.0],
        [2.765580620043941, 6.223694339264295 , -170.0595346365626 , 4.0 , 0.35763558293735603 , 1 , 82 , 212.0],
        [2.5352267119789937, 6.1674422848943955 , -167.15581967638263 , 3.9115955561609512 , 0.390214446296058 , 1 , 83 , 213.0],
        [2.3266024746199734, 6.10774957602148 , -164.96660354650928 , 3.8249947643637716 , 0.4196802048154597 , 1 , 84 , 214.0],
        [2.1229880195335324, 6.042208902928426 , -163.02615514510748 , 3.098147836264472 , 0.4413507826285048 , 1 , 85 , 215.0],
        [1.8928681043351496, 5.955965265446021 , -160.2389051111673 , 3.4013715103822375 , 0.4438321121164902 , 1 , 86 , 216.0],
        [1.6836396334665231, 5.865812864947532 , -157.7358261772666 , 3.144132180388177 , 0.41886035061481014 , 1 , 87 , 217.0],
        [1.4721954613870896, 5.760516651518401 , -154.46110138548767 , 3.584806908504833 , 0.35697962636051256 , 1 , 88 , 218.0],
        [1.235490654859964, 5.626823957741997 , -151.38598705392187 , 3.4576246884281696 , 0.2638590532929706 , 1 , 88 , 219.0],
        [1.0455538539444496, 5.506194074581738 , -148.6072073833027 , 3.3126900426721457 , 0.20407086825888218 , 1 , 89 , 220.0]
    ]

    # Find the closet data point
    closeDataPointPositionDist = 9999
    closeDataPointPositionSpeed = 4
    closeDataPointPositionCenterDiff = 0
    closeDataPointPositionIsLeftInd = -1
    closeDataPointHeading = 0
    for eachData in dataMap:
        x2 = eachData[0]
        y2 = eachData[1]
        closeDataPointHeading = eachData[2]
        positionDist = math.sqrt((x2 - x)**2 + (y2 - y)**2)
        if positionDist < closeDataPointPositionDist:
            closeDataPointPositionDist = positionDist
            closeDataPointPositionSpeed = eachData[3]*(1 + ADDITIONAL_SPEED_RATE)
            if (closeDataPointPositionSpeed > 4):
                closeDataPointPositionSpeed = 4
            closeDataPointPositionCenterDiff = eachData[4]
            closeDataPointPositionIsLeftInd = eachData[5]
##### END: Ideal Route Data Map #####

##### START: POSITION REWARD #####
    # Reward for closing to the center line and Initial reward
    #centerDistRewardBase =  HUNDRED_SIX_BASE
    #centerDistRewardPower = HUNDRED_SIX_POWER
    #positionReward = ((1 - (distance_from_center / (track_width/2)))*centerDistRewardBase)**centerDistRewardPower
    
    positionDistRewardBase =  HUNDRED_SIX_BASE
    positionDistRewardPower = HUNDRED_SIX_POWER
    positionReward = (((1 - (closeDataPointPositionDist / track_width))*positionDistRewardBase)**positionDistRewardPower)

##### END: POSITION REWARD #####

##### START: RIGHT SIDE REWARD #####
    rightSideReward = 0
    if (is_left_of_center and closeDataPointPositionIsLeftInd == 1):
        rightSideReward = 100
    elif (not is_left_of_center and closeDataPointPositionIsLeftInd == 0):
        rightSideReward = 100
##### END: RIGHT SIDE REWARD #####

##### START: CENTER DISTANCE REWARD #####
    centerDistReward = 0
    centerDistRewardBase = HUNDRED_TWO_BASE
    centerDistRewardPOWER = HUNDRED_TWO_POWER
    if rightSideReward < 0:
        centerDistReward = ((1 - abs(distance_from_center - closeDataPointPositionCenterDiff)/(track_width/2))*centerDistRewardBase)**centerDistRewardPOWER
##### END: CENTER DISTANCE REWARD #####
    
##### START: SPEED REWARD #####
    # Power base speed reword calculatiomn
    speedRewardBase = HUNDRED_FOUR_BASE
    speedRewardPower = HUNDRED_FOUR_POWER
    targetSpeed = closeDataPointPositionSpeed
    speedReward = 0
    if abs(targetSpeed - speed) < 2:
        speedReward=((1-abs(targetSpeed - speed)/2)*speedRewardBase)**speedRewardPower
##### END: SPEED REWARD #####

##### START: DIRECTION REWARD #####
    # Calculate the direction of the center line based on the closest waypoints
    directionReward = 0
    next_point = waypoints[closest_waypoints[1]]
    prev_point = waypoints[closest_waypoints[0]]

    # Calculate the direction in radius, arctan2(dy, dx), the result is (-pi, pi) in radians
    track_direction = math.atan2(next_point[1] - prev_point[1], next_point[0] - prev_point[0])
    # Convert to degree
    track_direction = math.degrees(track_direction)

    # Calculate the difference between the track direction and the heading direction of the car
    direction_diff = abs(track_direction - heading)
    if direction_diff > 180:
        direction_diff = 360 - direction_diff
       
    # power base reward for angle difference
    directionBase = HUNDRED_TEN_BASE
    directionPower = HUNDRED_TEN_POWER
    headingDiff = abs(closeDataPointHeading - heading)
    directionReward = 0
    if (headingDiff < 30):
        directionReward= ((1 - headingDiff/30)*directionBase)**directionPower

 
##### END: DIRECTION REWARD #####
        
##### START: Progress reward #####
    progressBase = HUNDRED_FOUR_BASE
    progressPower = HUNDRED_FOUR_POWER
    progressReward = ((progress/100)*progressBase)**progressPower
##### END: Progress reward #####

##### START: STEP REWARD #####
    # Total num of steps we want the car to finish the lap, it will vary depends on the track length
    stepRewardFactor = 0
    baseNumSteps = 300
    if (steps < baseNumSteps):
        stepsProgress = (steps / baseNumSteps) * 100
        stepsProgressDiff = stepsProgress - progress
        progressStepDiff = progress - stepsProgress
        
        # Only apply the progress reward when steps faster than expected
        if (stepsProgressDiff) > 5:
            stepRewardFactor = 0.01
        elif (stepsProgressDiff) > 3:
            stepRewardFactor = 0.1
        elif (stepsProgressDiff) > 1:
            stepRewardFactor = 0.7
        elif (stepsProgressDiff) > 0:
            stepRewardFactor = 0.9
        else:
            stepRewardFactor = 1 + (progressStepDiff/100)*STEP_REWARD_RATE
    else:
        stepRewardFactor = 0.001
##### END: STEP REWARD #####

    reward=(POSITION_REWARD_RATE*positionReward+RIGHT_SIDE_REWARD_RATE*rightSideReward+CENTER_DIST_REWARD_RATE*centerDistReward+SPEED_REWARD_RATE*speedReward+DIRECTION_REWARD_RATE*directionReward+progressReward*PROGRESS_REWARD_RATE)*stepRewardFactor
    
    if not all_wheels_on_track:
        reward*=0.7
        
    if is_crashed or is_offtrack or is_reversed:
        reward = 0

    is_left_of_center_ind = 0
    if is_left_of_center:
        is_left_of_center_ind = 1
        

    print('SIM_DATA_LOG:', x, ',', y, ',', heading, ',', speed, ',', distance_from_center, ',', is_left_of_center_ind, ',', closest_waypoints[1], ',', steps)
    print('steps: ', steps)
    print('progress: ', progress)
    print('closest_waypoints: ', closest_waypoints)
    print('track_width: ', track_width)
    #print('waypoints: ', waypoints)
    print('x: ', x)
    print('y: ', y)
    print('speed: ', speed)
    print('is_offtrack: ', is_offtrack)
    print('is_left_of_center', is_left_of_center)
    print('distance_from_center', distance_from_center)
    print('direction_diff: ', direction_diff)
    print('positionReward: ', positionReward)
    print('rightSideReward: ', rightSideReward)
    print('centerDistReward: ', centerDistReward)
    print('speedReward: ', speedReward)
    print('directionReward: ', directionReward)
    print('progressReward: ', progressReward)
    
    print('stepRewardFactor: ', stepRewardFactor)
    print('reward: ', reward)
    
    return float(reward)